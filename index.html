<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Monitor</title>
    <link rel="stylesheet" href="static/main.css">
    <script>
        if (!console) {
            var nop = function(){};
            console = {
                'log': nop,
                'dir': nop,
            };
        }

        var markError = function(row) {
            var setError = function() {
                if (row.className == 'errorf')
                    row.className = 'error';
            };
            var setErrorFlash = function() {
                if (row.className == 'error')
                    row.className = 'errorf';
            };
            row.className = 'errorf';
            for (var i = 0; i < 17; ++i) {
                if (i % 2 == 0) {
                    setTimeout(setError, 100*i);
                } else {
                    setTimeout(setErrorFlash, 100*i);
                }
            }
        };
        var receiveData = function(dat) {
            var tab = document.getElementById('services');
            for (var service in dat) {
                var serviceID = 'srv-' + service;
                var elem = document.getElementById(serviceID);
                if (elem === null) {
                    elem = document.createElement('tr');
                    elem.setAttribute('id', serviceID);
                    var key = document.createElement('td');
                    var keyN = document.createTextNode(service);
                    key.appendChild(keyN);
                    var value = document.createElement('td');
                    elem.appendChild(key);
                    elem.appendChild(value);
                    tab.appendChild(elem);
                }
                var newStatus = dat[service];
                var statusField = elem.childNodes[1];
                if (newStatus === null) {
                    elem.className = 'ok';
                    statusField.innerHTML = 'OK';
                } else {
                    if (elem.className !== 'error') {
                        markError(elem);
                    }
                    statusField.innerHTML = newStatus;
                }
            }
        };

        var RELOAD_DELAY = 100;
        var killHandle;
        var errorHandle;
        var es = new EventSource('stream');

        var reloadStream = function(reason) {
            console.log("About to reload stream (" + reason + ")");
            // Clear any kill handles if there are any -- we don't want
            // to double-kill the stream
            if (killHandle) {
                clearTimeout(killHandle);
                killHandle = null;
            }

            // grab the url from the stream so we can re-create it
            var url = es.url;
            es.close();

            // reload the stream after a short delay, gives the system
            // time to settle if needed.
            setTimeout(function() {
                console.log("Creating replacement stream with url: '" + url + "'.");
                es = new EventSource(url);
                connectToStream(es);
            }, RELOAD_DELAY);
        };

        var delayKill = function(howLongSeconds) {
            if (killHandle) {
                clearTimeout(killHandle);
            }
            console.log("Setting up stream reload in " + howLongSeconds + " seconds (if no pings before then).");
            killHandle = setTimeout(function() {
                var msg = 'No pings for ' + howLongSeconds + ' seconds.'
                receiveData({'Monitor': msg});
                reloadStream(msg);
            }, howLongSeconds * 1000);
        };

        var connectToStream = function(es) {
            es.onmessage = function(evt) {
                var dat = JSON.parse(evt.data);

                console.log("Got message:");
                console.dir(dat);

                receiveData({'Monitor': null});

                if ('ping' in dat) {
                    var interval = dat.ping;
                    var timeToError = interval * 2.5;
                    delayKill(timeToError);
                    return;
                }

                var statuses = dat.statuses;
                receiveData(statuses);
            };
            es.onerror = function(err) {
                console.log('stream error:');
                console.dir(err);

                // If there isn't an error marker pending, set on up.
                // It will only fire if the stream doesn't reload in time.
                if (!errorHandle) {
                    errorHandle = setTimeout(function() {
                        // Clear the handle (which we're acting as) so
                        // others can be set up if needed
                        if (errorHandle) {
                            clearTimeout(errorHandle);
                            errorHandle = null;
                        }

                        receiveData({'Monitor': 'offline'});
                    }, RELOAD_DELAY * 2);
                }

                // Reload the stream. When the stream reloads
                reloadStream(err);
            };
            es.onopen = function() {
                console.log('stream open.');

                // If there's an error handle pending then clear it --
                // the stream is back up now and we don't really care.
                if (errorHandle) {
                    clearTimeout(errorHandle);
                    errorHandle = null;
                }

                receiveData({'Monitor': null});
            };
        };
        connectToStream(es);
    </script>
  </head>
  <body>
    <table id="services">
      <tr>
        <th>Service</th><th>Status</th>
      </tr>
      <tr class="ok" id="srv-Monitor"><td>Monitor</td><td>Connecting...</td></tr>
    </table>
  </body>
</html>
